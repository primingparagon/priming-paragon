name: Render deploy (sync envs from GitHub Secrets)

on:
  push:
    branches: [ main ]

jobs:
  sync-envs-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set variables
        run: echo "Preparing to sync secrets to Render"

      - name: Sync & Deploy each service
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          JWT_REFRESH_SECRET: ${{ secrets.JWT_REFRESH_SECRET }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          set -e
          # helper to create env
          create_env() {
            SERVICE_ID="$1"; KEY="$2"; VALUE="$3"
            if [ -z "$VALUE" ]; then
              echo "Skipping $KEY for $SERVICE_ID (empty)"
              return
            fi
            curl -s -X POST "https://api.render.com/v1/services/${SERVICE_ID}/env-vars" \
              -H "Authorization: Bearer ${RENDER_API_KEY}" \
              -H "Content-Type: application/json" \
              -d "{\"key\":\"${KEY}\",\"value\":\"${VALUE}\",\"secure\":true}" || true
          }

          # Set common envs for auth-service
          AUTH_ID="srv-d4qg5a49c44c73bcfc6g"
          create_env "$AUTH_ID" "SUPABASE_URL" "${SUPABASE_URL}"
          create_env "$AUTH_ID" "SUPABASE_SERVICE_ROLE_KEY" "${SUPABASE_SERVICE_ROLE_KEY}"
          create_env "$AUTH_ID" "DATABASE_URL" "${DATABASE_URL}"
          create_env "$AUTH_ID" "JWT_SECRET" "${JWT_SECRET}"
          create_env "$AUTH_ID" "JWT_REFRESH_SECRET" "${JWT_REFRESH_SECRET}"
          create_env "$AUTH_ID" "OPENAI_API_KEY" "${OPENAI_API_KEY}"
          create_env "$AUTH_ID" "GEMINI_API_KEY" "${GEMINI_API_KEY}"

          # Tutoring Engine
          TUTORING_ID="srv-d4qgbh3e5dus73en8uig"
          create_env "$TUTORING_ID" "SUPABASE_URL" "${SUPABASE_URL}"
          create_env "$TUTORING_ID" "SUPABASE_SERVICE_ROLE_KEY" "${SUPABASE_SERVICE_ROLE_KEY}"
          create_env "$TUTORING_ID" "DATABASE_URL" "${DATABASE_URL}"
          create_env "$TUTORING_ID" "OPENAI_API_KEY" "${OPENAI_API_KEY}"
          create_env "$TUTORING_ID" "GEMINI_API_KEY" "${GEMINI_API_KEY}"

          # Pedagogy ingest
          PED_ID="srv-d4qgckggjchc73bbktm0"
          create_env "$PED_ID" "SUPABASE_URL" "${SUPABASE_URL}"
          create_env "$PED_ID" "SUPABASE_SERVICE_ROLE_KEY" "${SUPABASE_SERVICE_ROLE_KEY}"
          create_env "$PED_ID" "OPENAI_API_KEY" "${OPENAI_API_KEY}"

          # CRM
          CRM_ID="srv-d4qgdip5pdvs738nh3ug"
          create_env "$CRM_ID" "DATABASE_URL" "${DATABASE_URL}"

          # Assessment + audit-log (optional)
          ASSESS_ID="srv-d4qgeo0gjchc73bblsjg"
          AUDIT_ID="srv-d4qgg7idbo4c73brl9r0"

          create_env "$ASSESS_ID" "DATABASE_URL" "${DATABASE_URL}"
          create_env "$AUDIT_ID" "DATABASE_URL" "${DATABASE_URL}"

          # Trigger deploys
          curl -s -X POST "https://api.render.com/deploy/${AUTH_ID}" -H "Authorization: Bearer ${RENDER_API_KEY}" || true
          curl -s -X POST "https://api.render.com/deploy/srv-d4qga06uk2gs73fmdg20" -H "Authorization: Bearer ${RENDER_API_KEY}" || true
          curl -s -X POST "https://api.render.com/deploy/${TUTORING_ID}" -H "Authorization: Bearer ${RENDER_API_KEY}" || true
          curl -s -X POST "https://api.render.com/deploy/${PED_ID}" -H "Authorization: Bearer ${RENDER_API_KEY}" || true
          curl -s -X POST "https://api.render.com/deploy/${CRM_ID}" -H "Authorization: Bearer ${RENDER_API_KEY}" || true
